"use strict";$(function(){function a(a){var b=this;this.cssgInput=$("#cssgInput"),this.cssgOutput=$("#cssgOutput"),this.cssgOutputValue=[],this.cssgLevels=$("#cssgLevels"),this.cssgSetIndent=$('input[name="indentation"]'),this.cssgSetLine=$('input[name="lineheight"]'),this.cssgSetMod=$('input[name="modifier"]'),this.cssgSetOutput=$('input[name="output"]'),this.cssgSetSpace=$('input[name="rulespace"]'),this.cssgSetTrim=$('input[name="trimtext"]'),this.cssgSetAuto=$('input[name="autorecalc"]'),this.cssgSetTags=$('input[name="tagnames"]'),this.cssgClear=$("#cssgClear"),this.cssgInit=$("#cssgInit"),this.done=!1,this.settings={indentation:"	",indentationVal:{0:"	",1:"  ",2:"    "},lineheight:"\n\n",lineheightVal:{0:"\n\n",1:"\n",2:"\n\n\n"},trimtext:!0,rulespace:!0,autorecalc:!0,tagnames:!1,modifier:"__",modifierVal:{0:"__",1:"_",2:"--",3:"-"},output:"cssg",outputVal:{0:"cssg",1:"css",2:"haml"},moddistance:2,textRes:{empty:"Need moar raw HTML...",error:"Can't process this HTML..."}},a&&(this.settings=$.extend({},this.settings,a)),this.cssgSetters=[b.cssgSetIndent,b.cssgSetLine,b.cssgSetMod,b.cssgSetOutput,b.cssgSetSpace,b.cssgSetTrim,b.cssgSetAuto,b.cssgSetTags],this.cssgSetters.map(function(a){var c=a,d=c.get(0).name,e=c.get(0).type;switch(e){case"radio":c.on("click",function(){c.checked="checked",b.setValue(d,c.filter(":checked").val()),b.recalc()});break;case"checkbox":c.on("change",function(){b.setValue(d,c.get(0).checked?!0:!1),b.recalc()})}}),this.cssgSetAuto.on({change:function(){this.checked?b.cssgInit.hide():b.cssgInit.show()}}),this.setValue("indentation",b.cssgSetIndent.filter(":checked").val()),this.setValue("lineheight",b.cssgSetLine.filter(":checked").val()),this.setValue("modifier",b.cssgSetMod.filter(":checked").val()),this.setValue("output",b.cssgSetOutput.filter(":checked").val()),this.setValue("rulespace",!("checked"!=b.cssgSetSpace.attr("checked"))),this.setValue("trimtext",!("checked"!=b.cssgSetTrim.attr("checked"))),this.setValue("tagnames",!("checked"!=b.cssgSetTags.attr("checked"))),this.setValue("autorecalc",!("checked"!=b.cssgSetAuto.attr("checked"))),"checked"==this.cssgSetAuto.attr("checked")?(this.cssgInit.hide(),this.init()):this.cssgInit.show(),this.cssgInit.on({click:function(){return b.init(),!1}}),this.cssgClear.on({click:function(){return b.cssgOutputValue=[],b.cssgInput.val(""),b.cssgOutput.val(""),!1}}),this.cssgOutput.on({"click focus":function(){var a=this;a.onmouseup=function(){return a.onmouseup=null,!1}}});var c={to:300,id:null};this.cssgInput.on({"keyup paste cut":function(){!c.id&&b.settings.autorecalc&&(c.id=setTimeout(function(){b.recalc(),clearTimeout(c.id),c.id=null},c.to))}})}var b={spaceBetweenTags:new RegExp("(^|>)([^<]+)","g"),validXML:new RegExp("(<([^>]+)>)","ig"),clearWhitespace:new RegExp("\\s*\\n+\\s*","g"),hasSymbols:new RegExp("[^\\s]+","g"),str:{allSymbols:"[A-Za-z0-9]+"}};return String.prototype.cleanHtml=function(){return this.replace(b.spaceBetweenTags,"$1")},a.prototype.setValue=function(a,b){this.settings[a]=this.settings[a+"Val"]?this.settings[a+"Val"][b]:b},a.prototype.err=function(a,b){var c=this;return this.cssgOutput.val(c.settings.textRes[a]),b&&"function"==typeof b?b():void 0},a.prototype.levels=function(a){this.cssgLevels.text(a?a:0)},a.prototype.init=function(){var a=this.cssgInput.val();return this.cssgOutputValue=[],this.done=!1,this.cssgOutput.val(""),a&&(a=a.trim()),a?/(<([^>]+)>)/gi.test(a)?(this.settings.trimtext&&(a=a.cleanHtml()),void this.process(a)):void this.err("error"):void this.err("empty")},a.prototype.recalc=function(){this.init()},a.prototype.outputRender=function(a,b){switch(this.settings.output){case"css":a+=" {}";break;case"haml":a=(b?"%":"")+a}return a},a.prototype.refine=function(a){var c=this,d=($(a),""),e=a.nodeName.toLowerCase(),f="";if(3==a.nodeType&&(f=a.nodeValue.trim().replace(b.clearWhitespace," ")),1==a.nodeType)if(d=a.getAttribute("class")){var g=d.split(" "),h=[],i=[],j=[],k=new RegExp("^"+c.settings.modifier+b.str.allSymbols),l=new RegExp(b.str.allSymbols+c.settings.modifier+b.str.allSymbols),m=(new RegExp(c.settings.modifier),function(){for(var a="",b=0;b<c.settings.moddistance;b++)a+="	";return a}()),n=[];n=$.grep(g,function(a){return l.test(a)},!0),n=$.grep(n,function(a){return k.test(a)},!0),"cssg"!=this.settings.output?(n=n[0],f=this.outputRender((c.settings.tagnames?e:"")+"."+n,c.settings.tagnames)):(n=n.join(" . "),j=$.grep(g,function(a){return k.test(a)}),i=$.grep(g,function(a){return l.test(a)}),i=$.map(i,function(a){return a.substr(a.indexOf(c.settings.modifier),a.length)}),h=j.concat(i),h.length&&(h=m+h.join(" "),f=h),f=(this.settings.tagnames?e+" . ":"")+n+f)}else f="cssg"!=this.settings.output?this.outputRender(e,!0):e;return f},a.prototype.process=function(a){var b,c,d,e=this,f=document.createElement("div"),g=f,h="",i=this.settings.indentation.length,j=this.settings.lineheight,k=0,l=0,m=0;for(f.innerHTML=a;g;){if(b=g,m=h.split(e.settings.indentation).length-1,l=m>l?m:l,(1==b.nodeType||3==b.nodeType&&/[^\s]+/g.test(b.nodeValue))&&0!=k&&(this.settings.rulespace&&b.previousSibling&&b.previousSibling.firstChild&&(this.cssgOutputValue+=j),this.cssgOutputValue+=h.substr(i)+this.refine(b,h.length/i)+j),g.firstChild)g=g.firstChild,h+=this.settings.indentation;else{for(c=g.nextSibling,d=g.parentNode;null==c&&d;)c=d.nextSibling,d=d.parentNode,h=h.substr(0,h.length-i);g=c}k++}this.levels(l),this.cssgOutput.val(e.cssgOutputValue),this.done=!0},new a});